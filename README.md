# Next + Module Federation

webpack module federation 환경에서, next를 얼마나 써먹을 수 있을까

## 설계

- [x] Next에서 페이지 하나당 single entry를 가지는 federated module
- [ ] 클라이언트, 서버 라우팅간 vendor 양상 파악 -> 블로그 글감,,,
- [x] 각 entries 앱을 독립적으로 띄울 수 있는 DX(standalone)
- [ ] Full SSG fallback - Next앱 전체를 스태틱으로 구성하기
- [x] 배포 환경에 따른 path 구축 -> Next의 PROCESS.env 사용
- [x] 단일한 config 구성
- [ ] turborepo를 써먹을 여지를 엿보기
- [ ] s3로 배포 환경 구축하기(remote - s3, host - docker heroku?)
- [ ] 공통요소를 배포하는 것으로 변경사항 적용하기

## 느낀점

- 모듈 공유의 난이도가 수직상승한다........
- 호스트에서 리모트 주소를 dev, prod에 따라 바꿔치우면 될듯
- Next를 동원하는 fast refresh에 좀 애로가 있을듯함. "그 라이브러리" 쓰면 해결될 수도 있긴 함
  - 근데 또... 어찌어찌 해서 한 모듈(react app)만 수정할 수 있는 환경을 만들어주면 또 어찌어찌..?
    - 이런 경우에 요청에 필요한 쿠키 등의 정보는 또 손으로 넣어줘야하는디
  - 여러가지 모듈이 호스트앱에 어떻게 붙는지를 보고 싶다면 fast-refresh 포기해야함
  - 배포 단위를 하나의 앱만 수정할 수 있을... 니즈를 가지고 진행되어야 하면 좋을 것 같음
- Next는 청킹할때 React, React-dom을 묶어서 framework 번들로 만들어내는데, 그 아래 federation는 이 번들을 사용할 수 있나?
  - 딱 봤을때는 못하는거같긴한데, React를 두번 불러오지는 또 않는것 같아서
  - 뭔가 module federation만의 번들 불러오는 그런 무언가가 있나 싶음 -> 이거는 한번 따로 공부해보기
- 페이지를 넘나들때는 모듈을 항상 동적으로 가져올 것이기 때문에 항상 다시 로드를 해야할지도 모르겠다
  - 그렇다면 역시 현실적인 단위로 나눠져야 할텐데,,
  - 클라이언트 라우팅단에서 해결되야될거같은데,,,
  - 클라이언트 라우팅 시도했을때 모듈이 유실되는지는 보자. 아마 SSR 라우팅에서 유실될듯
- **Remote에서는 Next의 API를 사용할 수 있는 표준 인터페이스를 가지고 있어야 하고, 이역시 런타임에 주입됨**
  - Next 관련된 컨텍스트가 빌드타임에 들어가면 안 되기 때문.
  - DI가 필요하다는 말임. 대표적으로 Next단의 라우팅, Next와 얽혀있는 i18n 관련 등등
  - Context로 해볼라다가 실패함, context를 직접 참조해야하기 때문인데.. 뭐 외부패키지로 분리하면 가능이야 하겠지만 글쎄? 좀더 쉬운 솔루션이 있으면 좋겠는데..
  - 번들링을 방지하기 위한 수단으로 사용해볼수도 있을거같음? 즉, 정말 DI 수단으로 사용하는거심
- HMR을 어떻게 가능케할 수 있을까?
  - 리모트의 코드가 바뀌었을 때 Next의 코드도 바뀌었다는 것을 인식하게 할 수 있으면 됨 -> 해싱의 변화를 적용하는 방법이 필요
- **각 federated된 앱들이 서로 소통할 수 있을까?????**
  - 진짜 마이크로서비스처럼. 뭔가를 특정 포트로 던지면 받을 수 있는 인터페이스가 가능하다면?

## 의문점

- next는 어디까지 역할을 할까?
- remote앱들 굳이 package의 형태를 취해야 할까? 혹은 하나하나가 배포단위라고 보면?
- next에서 잘 있을 수 있게 즉당한 구조를 가질 수 있게 해야한다.
- 공통모듈 의존시키는거 어려울거같은데... 걔도 어쨋든 다이나믹 임포트 되야되는거 아닌가
